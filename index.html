<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title></title>
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
 <link rel="stylesheet" href="css/style.css" media="screen" type="text/css" />
 <script src="../scripts/jquery-1.3.1.js" type="text/javascript"></script>
	<script type="text/javascript">
	 
		$(function(){
		    //定义时间戳
			timestamp = 0;
			updateStatus = true;
			
			//调用更新信息函数
			updateMsg();
			//表单提交
			$(".chatform").submit(function funcSubmit(){
				updateStatus = false;
				var picPath = $("#face img").filter(".current")[0].src;
				var index = picPath.lastIndexOf("\/");  
				var picName = picPath.substring(index + 1, picPath.length);
				$.post("backend.php",{
							message: $("#msg").val(),
							name: $("#author").val(),
							action: "postmsg",
							time: timestamp,
							pic: picName
						}, function(xml) {
					//清空信息文本框内容
					$("#msg").val("");
					//调用解析xml的函数
					
					addMessages(xml);
							});
				return false; //阻止表单提交
			});
			$("#face img").click(function(){
				$(this).addClass("current").siblings().removeClass("current");
			})
			
		});
        //更新信息函数，每隔一定时间去服务端读取数据
		function updateMsg(){
			if (updateStatus == true) {
				$.post("backend.php",{ time: timestamp }, function(xml) {
				//调用解析xml的函数
				addMessages(xml);
				});
			}
			//每隔4秒，读取一次.
			setTimeout('updateMsg()', 100);
		}
        //解析xml文档函数，把数据显示到页面上
		function addMessages(xml) {
		    //如果状态为2，则终止
			if($("status",xml).text() == "2") return;
			//更新时间戳
//			timestamp = $("time",xml).text();
			//$.each循环数据
			$("message",xml).each(function() {
			    var author = $("author",this).text(); //发布者
				var content = $("text",this).text();  //内容
				timestamp = $("time",this).text();  //内容
//				var htmlcode = "<strong>"+author+"</strong>: "+content+"<br />";
				var userpic = "img/" + $("pic",this).text();
				var htmlcode = "<li><div class=\"userPic\"><img src=\"" + userpic + "\"></div>\
							 <div class=\"content\">\
							 	<div class=\"author\"><a href=\"javascript:;\">" + author + "</a>:</div>\
								<div class=\"msgInfo\">" + content + "</div>\
								<div class=\"times\"><span>" + timeFormat(timestamp) +
									"</span></div>\
							 </div></li>";
				$(".messagewindow").append( htmlcode ); //添加到文档中
				$(".messagewindow").scrollTop($('.messagewindow')[0].scrollHeight);
				updateStatus = true;				
			});
			
			
			
		}
		
		function timeFormat(curTime){//将当前时间转换成yyyymmdd格式
			curTimeToStr = curTime.toString(); 	
			curTimeToStr = curTimeToStr.substr(4,2) + "\u6708" + curTimeToStr.substr(6,2) + "\u65e5 " + curTimeToStr.substr(8,2) + ":" + curTimeToStr.substr(10,2);
			return curTimeToStr;
		  }
	</script>
	
</head>
<body>

	<div id="msgBox">
		<ul class="messagewindow"  >
<!--
 			<li >
				<div class="userPic">
					<img src="img/face1.gif">
				</div>							 
				<div class="content">							 	
					<div class="author">
						<a href="javascript:;">ssss</a>:
					</div>								
					<div class="msgInfo">s</div>						
					<div class="times">
						<span>12月04日 12:03</span>
					</div>						
				</div>
			</li>
			
-->
			 
			
			
		</ul>
<!--		<p id="messagewindow"><span id="loading">加载中...</span></p>-->
		<form class="chatform" action="#">
			
			<div>
				<input id="author" class="" value="">
				<p id="face"><img src="img/face1.gif" class="current"><img src="img/face2.gif" class=""><img src="img/face3.gif" class=""><img src="img/face4.gif" class=""><img src="img/face5.gif" class=""><img src="img/face6.gif" class=""><img src="img/face7.gif" class=""><img src="img/face8.gif" class=""></p>
			</div>
			<div>
				<textarea id="msg" class=""></textarea>
			</div>
			<div class="tr">
				<p>
					<input id="sendBtn" type="submit" value="" title="快捷键 Ctrl+Enter" class="">
				</p>
			</div>
		</form>
		
<!--			姓名： <input type="text" id="author" size="50"/><br />-->
<!--			内容： <input type="text" id="msg"  size="50"/>   <br /> -->
<!--			<input type="submit" value="发送" /><br />-->
		
	</div>

</body>
</html>


 